
# Proxmox

Proxmox is a free and open source type 1 hypervisor that is popular with home lab builders. It is a Debian Linux based OS that can be installed on almost anything, although your mileage may vary depending on the strength of the hardware you give it. In my case I will be installing on my desktop PC that I was previously using for gaming. 

I won't go into the specifics of how to install Proxmox, but you basically just download and install the Proxmox ISO to a flash drive and plug it into your computer. If you don't know what you're doing here just look up a video.

## Updating Proxmox

First make sure Proxmox is up to date. Open a new shell console by clicking on your PVE Node and selecting Shell. You will likely need to disable the subscription update sources and create a source list for no-subscription updates. This can be done with the commands below:

```
sed -i '1s/^/Enabled: no\n/' /etc/apt/sources.list.d/pve-enterprise.sources
sed -i '1s/^/Enabled: no\n/' /etc/apt/sources.list.d/ceph.sources    # if youâ€™re not using Ceph

cat > /etc/apt/sources.list.d/proxmox.sources <<'EOF'
Types: deb
URIs: http://download.proxmox.com/debian/pve
Suites: trixie
Components: pve-no-subscription
Signed-By: /usr/share/keyrings/proxmox-archive-keyring.gpg
EOF
```

Now you can update and reboot Proxmox with the following commands:

```
apt update && apt full-upgrade -y
reboot
```

## Tweaking Network Settings 

Now that Proxmox is updated we need to make a lab sub network that is isolated from the main home network that Proxmox sits on. Click `Datacenter > [Node] > Network` to get network settings for the current Proxmox node. We will want to make sure we have two bridges, `vmbr0` and `vmbr1` which will be the bridge to our outside and inside networks respectively.

![[1. Lab Setup-1.png]]

> Note: I have chosen to call my node "tower"

First we want to make sure `vmbr0` exists and is set to VLAN aware: `Yes`. To make changes to the bridge just double click it, then check the box for VLAN aware.

![[1. Lab Setup-2.png]]

Next we will need to create the a new bridge for `vmbr1`. Just click `Datacenter > [Node] > Network > Create > Linux Brige` to open up the create wizard. The name should autofill to `vmbr1` but you will also need to make sure to click the VLAN Aware checkbox in this one as well. All other fields can be left blank. Once that is done save the settings by clicking Apply Configuration on the top of the Network config page.

# pfSense

pfSense is a free and open-sourced software that can operate as a router and firewall once installed on hardware. For our purposes, we can use it to create a walled-off network environment for the security lab. All of our devices will be connected to the PFSense router and PFSense will decide what connections are allowed. 

## Downloading ISO

To download the PFSense ISO to Proxmox via the console run the following commands:

```
mkdir -p /var/lib/vz/template/iso
cd /var/lib/vz/template/iso
wget https://kr2.mirrors.naho.moe/naho/pfSense/2.7.2/pfSense-CE-2.7.2-RELEASE-amd64.iso.gz
gunzip pfSense-CE-2.7.2-RELEASE-amd64.iso.gzls
```

Once that is downloaded and unzipped you can go to `Datacenter > [Node] > local ([Node]) > ISO Images` where you can verify the ISO is recognized by Proxmox. 

![[1. Lab Setup-3.png]]

Now this ISO can be used to create a new pfSense VM. 

## Create VM

To get started creating the pfSense VM you just have to click the Create VM button in the top right of the Proxmox portal.

![[1. Lab Setup-4.png]]

This will open a pop-up Create: Virtual Machine wizard you can use to tweak the details of the VM before installing it. I will use the following settings to create one for pfSense:

- General Page
	- **VM ID**: 900
	- **Name**: pfSense
- OS Page
	- **ISO**: Select the ISO disk from previous step
- System Page
	- **Machine**: Default (i440fx)
	- **BIOS**: Default (SeaBIOS)
	- **SCSI Controller**: VirtIO SCSI single
- Disks Page
	- **Size**: 20GB
	- **Cache**: Write back
- CPU Page
	- **Cores**: 2
	- **Type**: host
- Memory Page
	- **Memory (MiB)**: 2048
- Network Page
	- **Bridge**: vmbr0
	- **Model**: VirtIO (paravirtualized)
	- **Firewall**: Checked

Before starting up the pfSense VM we need to add another network interface so the router has a WAN and LAN port. Go to `Datacenter > [Node] > pfSense > Hardware > Add > Network Device` and give it the following settings:

- **Bridge**: vmbr1
- **Model**: VirtIO (paravirtualized)
- **Firewall**: Checked

Now you can start the pfSense VM by going to `Datacenter > [Node] > pfSense > Console` and clicking the Start Now button, or by clicking the Start button in the top right corner of Proxmox when pfSense is selected.

![[1. Lab Setup-5.png]]

You will get to an installer that will guide you through the pfSense VM install.

![[1. Lab Setup-6.png]]

When prompted for partitioning select Auto (UFS) > Entire Disk > MBR > Finish > Commit to allow the installer to build the file system and boot manager. Once it gets to the end it will ask to reboot. Confirm the request and wait for the VM to come back online. 

After booting up, pfSense will ask a few questions:
- Should VLANs be set up now? -> n
- Enter the WAN interface name -> vtnet0
- Enter the LAN interface name -> vtnet1

pfSense will spin up and begin configuring itself. Once its done you will see a CLI menu of options. Select `2) Set interface(s) IP address` so we can update the interfaces.

![[1. Lab Setup-7.png]]

Make the following changes within this menu:

- WAN
	- IPv4: DHCP
	- IPv6: DHCP
	- Revert to HTTP as webConfigurator: n
- LAN
	- IPv4: Static
	- IPv4 Address: 172.16.0.1/24
	- Enable DHCP on LAN: y
	- Start Address: 172.16.0.100
	- End Address: 172.16.0.200
	- Revert to HTTP as webConfigurator: n

Once this is done you will be brought back to the pfSense console menu. You can test the connection on the WAN side by choosing option 8 to open a shell interface and running `ping -c 3 8.8.8.8` to ensure you are able to send and receive packets. If it fails here something did not set up correctly in the previous steps.

# Tailscale 

Now that I have pfSense up and running, any new VM I create for the lab will connect to the pfSense LAN interface rather than the Proxmox interface. This way, all lab devices are contained within their own network and segregated from the main home network it sits within. However, once the network is walled off we will need a way to connect to it. 

My plan is to create a small Tailscale VM, set it to advertise the pfSense LAN network, then set ACL rules to keep it separated from my Home Network.

> My setup will have two Tailscale VMs, one on the home network advertising the home subnet, and another on the lab network advertising the lab subnet. This way I can remotely connect to both networks without them bleeding into each other. My instructions will assume you want to set it up this way and have the home Tailscale VM already setup. You can repeat the instructions here to setup both. 

