
# Previous [[2. Windows Environment]]

Security Onion is a Swiss Army Knife of security tools that has several different systems built in such as Zeek, Suricata, osquery and can be used to monitor networks and capture network packets. For this lab we will use it mainly as a network monitor that will forward Zeek logs to Splunk for log analysis. 

# Download ISO

Installing Security Onion is similar to the other VMs so far. First we need to download the ISO to Proxmox, then build out a VM for it in the Wizard. Here's a few commands you can use to download Security Onion from the Proxmox terminal:

```
STORAGEPATH="/var/lib/vz/template/iso"
VERSION="2.4.180-20250916"
ISO="securityonion-${VERSION}.iso"
ISO_URL="https://download.securityonion.net/file/securityonion/${ISO}"

wget -c -L -O "${STORAGEPATH}/${ISO}" "${ISO_URL}"
```

The ISO file is rather large (14GB) so you may want to go take a break while waiting for this to finish. Once its done you can click the Create VM in the top right corner of Proxmox to start the wizard. I used the following config for Security Onion:

- **VM ID**: 904
- **Name**: SecOnion-Lab
- **Disk size**: 250GB
- **CPU Cores**: 4
- **Memory**: 24GB
- **Bridge**: vmbr1

# SPAN port

Before turning on the machine and installing Security Onion we will need to make some changes to the network settings. Security Onion has the ability to listen to the network on a second port on the network called a SPAN port that allows it to hear all traffic flowing through the network, not just those intended for the SO machine or broadcasts to all machines. This means Security Onion can hear two other machines on the network talking to each other, which would be impossible only using the one standard network connection. 

![[3. Security Onion-1.png]]

We will need to make some changes within Proxmox to allow for this. Specifically we will want to make another network interface `vmbr2` and mirror all of the traffic from `vmbr1` to it. All of the lab machines will connect to `vmbr1` and it will share this to `vmbr2` so that Security Onion can monitor it. 

First let's create `vmbr2` by going to `Datacenter > [Node] > System > Network > Create > OVS Bridge. 

- **Name**: vmbr2
- **IPv4/IPv6**: None
- **Bridge ports**: Blank 

Then click Create > Apply Configuration to save the settings. Next we need to attach `vmbr2` to our Security Onion VM by going to `Datacenter > [Node] > SecOnion-Lab > Hardware > Add > Network Device > OVS Bridge`. Use the following settings:

- **Model**: VirtIO (paravirtualized)
- **Bridge**: vmbr2
- **Firewall**: Unchecked

Lastly we need to apply the settings to mirror `vmbr1` over to `vmbr2`. This can be done by going to the Proxmox terminal at `Datacenter > [Node] > Shell` and running this command:

```
ovs-vsctl clear bridge vmbr1 mirrors 
ovs-vsctl -- --id=@p get port tap904i1 -- --id=@m create mirror name=span1 select-all=true output-port=@p -- set bridge vmbr1 mirrors=@m
```

To make this script persistent across reboots run the command `nano /root/span.sh` to create a new script in the /root/ folder called span.sh. Now add the following text to the file:

```
#!/bin/bash
sleep 60
ovs-vsctl clear bridge vmbr1 mirrors
ovs-vsctl -- --id=@p get port tap101i1 -- --id=@m create mirror name=span1 select-all=true output-port=@p -- set bridge vmbr1 mirrors=@m
```

Next run `chmod +x /root/span.sh` to make the file executable. Now we need to add it to Proxmox's Crontab so it runs every reboot:

```
echo "@reboot root /root/span.sh" >> /etc/crontab
service cron reload
```

# Set Static Mapping

Now find the MAC address of the Security Onion VM by going to `Datacenter > [Node] > Hardware > Network Device (net0)` which should be the NIC of the vmbr1 network interface. Now lets go to the pfSense console at https://172.16.0.1 and log in with your admin account. 
Next go to `Services > DHCP Server > Add Static Mappings` and add a new entry for Security Onion. Paste in the MAC address for the Security Onion VM vmbr1 NIC and set it to the IP address 172.16.0.12. Now click Save > Apply Changes to save the mapping.

# Install VM

Now we can turn on the Security Onion VM and walk through setup. After clicking Start go to the console page for the VM where you should be greeted with the initial install page for Security Onion. You can select the first option which will give us a standard Security Onion install. 

![[3. Security Onion-3.png]]

You will then be asked whether it's okay to delete the contents of the VM hard drive to install Security Onion. Since this is a fresh virtual HD we have nothing to worry about.

![[3. Security Onion-4.png]]

Type `yes` to continue. You will then be asked to create an administrative user for this install. I chose the name `admin` and gave it a strong password. Next it will kick off the installer. You will need to let this run for a while. Eventually you will see a screen asking you to press Enter to Reboot. Do that and wait for it to turn back on. 

After the reboot finishes Security Onion will ask you to login with the account created during setup. Give it those credentials then click Yes on the screen asking you to continue.

![[3. Security Onion-5.png]]

Next choose Install from the menu. 

![[3. Security Onion-6.png]]

On the next screen choose Standalone.

![[3. Security Onion-7.png]]

Type AGREE to accept the license terms then select Standard as the network type.

![[3. Security Onion-8.png]]

Give it the hostname seconion-lab to match the Proxmox naming.

![[3. Security Onion-9.png]]

> Note: Uppercase characters can cause conflicts in some instances so its best to make sure your hostname uses all lowercase.

Next you will be asked to select the NIC to be used for management. This is referring to the standard network connection that will be provided by the vmbr1 interface. Make sure to select the correct MAC address that corresponds to this NIC. 

> Note: You may have to look at the hardware settings for the Security Onion VM to tell these apart.

![[3. Security Onion-10.png]]

Next it will ask whether to use a Static IP or DHCP. I will set it to DHCP here so that our pfSense static mapping can take over. On the next page you will be warned that a DHCP address can cause problems but don't worry about that if you have the static mapping in pfSense set up.

On the next two pages you will be asked whether to connect to the internet directly or via proxy and whether to use the default docker IP range. Choose direct and yes respectively.

![[3. Security Onion-11.png]]

On the next page you will be asked to select the Monitor Interface. We want to make sure the MAC address of the vmbr2 SPAN port we created is selected. You can tap the Spacebar with the selection highlighted to add an asterisk to the selection. Then click Ok to move on to the next page.

The next page will ask to enter an email address for an admin user. Provide this and create a strong password to go with it.

![[3. Security Onion-12.png]]

The next page will ask which method you would like to use to access the Security Onion web interface. Select IP here for simplicity. If we decide to implement DNS later we can come back to this. On the next page choose Yes to allow access to the web interface.

![[3. Security Onion-13.png]]

You will then be asked to provide an IP or network range that is allowed to view the web interface. Here enter 172.16.0.0/24 so it is visible from our network. Later we may want to consider restricting this down somewhat.

On the last page you will be given a list of your chosen configuration settings. Click Yes to approve these settings and let Security Onion go off and begin installing its necessary items.




