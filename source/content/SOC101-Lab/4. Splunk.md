
# Previous: [[3. Security Onion]]

Splunk is a powerful tool that can be used to collect, analyze, and visualize log data from virtually all devices on a network. It helps organizations monitor and investigate security issues that arise and help track events as they affect multiple devices. 

Splunk has options to deploy in the cloud or on premises. For our lab I am going to install it on-prem as another VM in Proxmox. From there we will just need to install the Splunk Universal Forwarder on all devices so that all events across the lab network can be viewed together in one place.

# (Optional) Developer License

Splunk has a very limited free plan that lets users ingest up to 500MB of log data per day as well as limits that lock you down to one single Splunk instance. This should be plenty for our lab, but if you can also sign up for a Splunk Developer License to get your ingest limit increased to 10GB per day. This will give a bit more overhead so you can get a bit more done in your labs if you want. 

Go to https://dev.splunk.com/enterprise/dev_license/ for instructions on how to sign up. You will need to create a Splunk account on the [Splunk Developer page](https://dev.splunk.com/developer-program/). The sign up page will ask you several questions about what you plan to do with the platform. I just said I was a student and hobbyist developer and that I just want to play around with the tools. 

# Download & Install VM

First we need to download and install Ubuntu Server as a base for Splunk to sit on. To download the Ubuntu Server 24.04 ISO to Proxmox run the following in a Proxmox shell:

```
STORAGEPATH="/var/lib/vz/template/iso"
VERSION="24.04.3"
ISO="ubuntu-${VERSION}-live-server-amd64.iso"
ISO_URL="https://releases.ubuntu.com/noble/${ISO}"
wget ${ISO_URL} -O ${STORAGEPATH}/${ISO}
```

Now Click Create VM in the top right to create a new Ubuntu Server VM with the following settings:

- **VM ID**: 905
- **Name**: Splunk-Lab
- **Start at boot**: Checked
- **Bus/Device**: VirtIO Block
- **Disk size**: 200 GB
- **CPU Cores**: 8
- **CPU Type**: host
- **Memory**: 16384
- **Bridge**: vmbr1

Before powering on the VM go into pfSense and give it a static IP mapping. I will chose 172.16.0.13 for Splunk. Remember this can be found by going to pfSense console at https://172.16.0.1 and selecting `Services > DHCP Server > Add Static Mapping` and connect the IP to the MAC address of the Splunk VM. When this is done click Save > Apply Changes to save the mapping.

Now just power it on and run through the Ubuntu Server setup. Here's a list of the settings I selected for the install:

- **Type of Installation**: Ubuntu Server
- **Search for Third Party Drivers**: Checked
- **Use Entire Disk**: Checked
- **Your name**: splunk
- **Server name**: splunk
- **Pick a username**: splunk
- **Install OpenSSH Server**: Checked

After finishing the install wizard it will ask you to confirm the settings and reboot the machine. Wait for everything to finish, then reboot.

# Installing Splunk

Once the Splunk VM comes back online you will be asked to login with the user created during setup. After logging in you will need to run a few commands to get the VM updated and make sure the qemu guest agent is installed.

```
sudo apt update && sudo apt upgrade -y
sudo apt install qemu-guest-agent -y && sudo systemctl enable qemu-guest-agent
sudo reboot
```

Wait for the VM to reboot then run the following commands to download, install, and start Splunk.

```
wget -O splunk.deb 'https://download.splunk.com/products/splunk/releases/10.0.1/linux/splunk-10.0.1-c486717c322b-linux-amd64.deb'
sudo dpkg -i splunk.deb
sudo /opt/splunk/bin/splunk start --accept-license
sudo /opt/splunk/bin/splunk enable boot-start
```

During setup you will be asked to create a new Splunk user. I chose the username `admin` and a strong password. 

Once the install is complete Splunk can be accessed by going to its URL at https://172.16.0.13:8000. You will need to then login using the username and password chosen during the Splunk install setup. You should then be taken the the default homepage for Splunk.

![[4. Splunk-1.png]]

I also added the following lines to allow Splunk through the UFW firewall:

```
sudo ufw allow 8000/tcp
sudo ufw allow 8089/tcp
sudo ufw enable
```

With this done we now just need to install the Splunk Universal Forwarder on all of our lab devices:

- pfSense
- Tailscale
- Windows Server
- Windows Workstation
- Security Onion

Once they are in place they will push log data from each device up into Splunk for us to analyze in the lab. Without this step there would still be no data to look at.

# Installing Forwarders

Splunk provides a convenient way to send log data from endpoints to the Splunk receiver by way of the [Splunk Universal Forwarder](https://www.splunk.com/en_us/download/universal-forwarder.html). It just has to be downloaded on each device and pointed to the Splunk server. Alternately, there are manual ways to export logs to Splunk, and for some of our VMs it will be the preferred way to do it.

## pfSense

Navigate to the pfSense web portal at https://172.16.0.1 and go to `Status > System Logs > Settings`. Check the box for `Send log messages to remote syslog server` which will open up a settings box below where you will need to enter the following:

- **Source Address**: Any
- **Remote Log Servers**: 172.16.0.13:514
- **Remote Syslog Contents**: Everything

![[4. Splunk-2.png]]

For now I will forward all types of logs here but it may make sense later to tighten this up and only select a few of these options.

With these set just hit Save and that should be all you need to do.

## Tailscale

Next we will want to log into a shell on our Tailscale-Lab machine and run the following commands to download and install the Splunk Universal Forwarder:

```
apt update && apt install -y wget
wget -O splunkforwarder-10.0.1-c486717c322b-linux-amd64.deb "https://download.splunk.com/products/universalforwarder/releases/10.0.1/linux/splunkforwarder-10.0.1-c486717c322b-linux-amd64.deb"
dpkg -i splunkforwarder-10.0.1-c486717c322b-linux-amd64.deb 
chown -R splunkfwd:splunkfwd /opt/splunkforwarder
```

Start Forwarder:

```
/opt/splunkforwarder/bin/splunk start --accept-license --answer-yes --no-prompt --seed-passwd STRONGPASSWORD
```

> Note: In the command above you will need to feed a strong password into the forwarder. This can be used at the forwarder web instance.

Next you will need to edit the config file so Splunk can forward to the right IP address with this command:

```
echo "[tcpout]
defaultGroup = splunkenterprise
[tcpout:splunkenterprise]
server = 172.16.0.13:9997" >> /opt/splunkforwarder/etc/system/local/outputs.conf
```

Now just restart Splunk to apply the changes:

```
/opt/splunkforwarder/bin/splunk restart
```

Once all that is in place the Tailscale VM should be good to go.

## Windows

The instructions for installing the forwarder for Windows 11 and Server are exactly the same so I will condense the info to just one section here. 

> Note: You will want to make sure you installed Sysmon back in the Windows Environment setup page. Sysmon logs will have much of the info we will want to collect from the Windows machines beyond the network logs.

Use the following script in an elevated (admin) PowerShell instance to download, install, and start the Splunk Universal Forwarder:

```
Invoke-WebRequest -Uri "https://download.splunk.com/products/universalforwarder/releases/10.0.1/windows/splunkforwarder-10.0.1-5d3a1c8c5a6a-x64-release.msi" -OutFile "splunkforwarder.msi"

msiexec.exe /i splunkforwarder.msi AGREETOLICENSE=Yes SPLUNKUSERNAME=admin SPLUNKPASSWORD=STRONGPASSWORD RECEIVING_INDEXER="172.16.0.13:9997" WINEVENTLOG_SEC_ENABLE=1 WINEVENTLOG_SYS_ENABLE=1 /quiet

Start-Service SplunkForwarder

Get-Service SplunkForwarder
```

> Note that the commands have a hardcoded forwarder password and IP address for the Splunk receiver

